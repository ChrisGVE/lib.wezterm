name: Run Tests

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Lua environment
      run: |
        # Install Lua and LuaRocks directly using apt
        sudo apt-get update
        sudo apt-get install -y lua5.3 liblua5.3-dev lua-check luarocks
        
        # Configure LuaRocks
        sudo luarocks install busted
        
        # Print environment info for debugging
        echo "Lua version:"
        lua -v
        echo "LuaRocks version:"
        luarocks --version
        echo "Current directory:"
        pwd
        echo "Directory listing:"
        ls -la
    
    - name: Run tests
      run: |
        busted --verbose tests/unit/
    
    - name: Run linter
      run: |
        luacheck . || [ $? -eq 1 ] && echo "Linting warnings are acceptable"
